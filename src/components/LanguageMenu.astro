---
import { Check, ChevronDown, Languages } from "@lucide/astro";
import { languages } from "src/lib/i18n/ui";

const currentLanguage = Astro.currentLocale || "en";
---

<details class="relative group" data-language-menu>
  <summary
    class="flex items-center gap-1.5 hover:text-blue-500 font-sans font-medium cursor-pointer list-none select-none"
  >
    <Languages class="w-5 h-5" />
    <span class="uppercase">{currentLanguage}</span>
    <ChevronDown
      class="w-4 h-4 text-slate-500 transition-transform group-open:rotate-180"
    />
  </summary>

  <div
    class="absolute right-0 mt-2 w-40 rounded-xl border border-slate-200 bg-white shadow-lg p-1 z-30"
  >
    {
      Object.entries(languages).map(([lang, label]) => (
        <a
          href={`/${lang}`}
          class:list={[
            "flex items-center justify-between gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 hover:text-blue-500 transition-colors",
            {
              "text-slate-900 font-semibold": lang === currentLanguage,
              "text-slate-700": lang !== currentLanguage,
            },
          ]}
        >
          <span>{label}</span>
          {lang === currentLanguage && <Check class="w-4 h-4" />}
        </a>
      ))
    }
  </div>
</details>

<style>
  summary::-webkit-details-marker {
    display: none;
  }
</style>

<script>
  function setupLanguageMenu() {
    const menus = document.querySelectorAll<HTMLDetailsElement>(
      "[data-language-menu]",
    );

    const closeMenus = () => menus.forEach((m) => m.removeAttribute("open"));

    document.addEventListener("pointerdown", (e) => {
      const target = e.target as HTMLElement;
      menus.forEach((menu) => {
        if (!menu.contains(target)) menu.removeAttribute("open");
      });
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenus();
    });
  }

  setupLanguageMenu();
  document.addEventListener("astro:after-swap", setupLanguageMenu);
</script>
